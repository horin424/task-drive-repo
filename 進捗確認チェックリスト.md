# Azure新規実装 進捗確認チェックリスト（総合）

本シートは、以下の資料をベースに高レベルの達成状況を確認するためのチェックリストです。各項目のチェック可否と、補足コメントを記入してください。

- 参照資料
  - [Azure議事録アプリ新規実装要件定義書](./Azure議事録アプリ新規実装要件定義書.md)
  - [README_for_Yoshimoto](./README_for_Yoshimoto.md)
  - [RFP](./RFP.md)

比較方針
- 本チェックは原則、以下のブランチとの差分を基準とします。
  - `/Users/ghost/development/transcript_minute_takewa/transcript-minute` の `main` ブランチ
  - 必要に応じて対象コミットを明記し、差分の根拠（ファイル/行/エンドポイント）をコメント欄に記載してください。

記入ルール（提案）
- [ ]: 未／未確認 / [x]: 完了 / [~]: 進行中 / [!]: 実装に問題あり（要修正）
- コメント欄に根拠（機能デモ・コード位置・関数/エンドポイント）と不足点を簡潔に記入
- 実装に問題がある場合は、詳細は別MDに記載（例: `docs/azure/実装問題詳細.md`）。本チェックリストには要約とリンクのみ記載

ステップ運用
- ステップ1・2（認証・認可構築／ストレージ・アップロード）は集計対象。
- ステップ3・4（バックエンド処理基盤・AI連携／運用基盤・本番展開）は必要に応じてチェックするが、のちの集計には含めない。

---

## 1. 認証・認可（Entra ID / B2C）
- [!] 認証/トークン取得・検証（MSAL設定/redirect/knownAuthorities/Access Token付与/401再試行）
  - コメント:
    - 【Step 1】`authority`/`knownAuthorities`/`redirectUri` の整合未確認（CIAM/B2C ドメイン・登録URIと一致要）
    - 【Step 1】`loginRequest`/`tokenRequest` のスコープ不統一（`access_as_user` 付与の徹底）
    - 【Step 1】API呼出時に Access Token（Bearer）未付与、401時の silent→再試行未実装
    - 【Step 4】認証ログのPII露出リスク（本番での詳細ログ抑制）
- [!] 認可/API保護（roles/groups統一・JWT検証・エンドポイント認可）
  - コメント:
    - 【Step 1】ロール判定が `roles`/`groups` 混在（Admin基準と判定ロジックの統一要）
    - 【Step 1】HTTP関数での JWT 検証（issuer/aud/scp/exp）未実装、エンドポイント認可不足
    - 【Step 2】SAS発行関数が匿名/関数キー依存（`GetUploadSasUrl`）→JWT必須へ変更要
    - 【Step 1】`create-session` 等も function key 依存で所有者/組織検証不足
    - 【Step 4】EasyAuth/APIM の JWT 検証ポリシー未導入

-## 2. ストレージ（Azure Blob）
- [!] ストレージ構成（コンテナ分離/階層/CORS/非公開）
  - コメント:
    - 【Step 2】`transcripts`/`outputs` と関数側 `uploads` が不一致（入力=transcripts/出力=outputsに統一）
    - 【Step 2】階層規約不一致：`private/{oid}/{sessionId}/…` に統一し、サーバ側で blobName を決定
    - 【Step 2】CORS 最小化（AllowedOrigins/Methods/Headers/ExposeHeaders/MaxAge）の確認不足
    - 【Step 2】Public access 無効（Blob/Container）確認不足
- [!] アップロードSASフロー（サーバ発行/最小権限・短期/PUTブロックアップロード/クォータ連動）
  - コメント:
    - 【Step 2】SAS発行関数が匿名/権限過大/長期（JWT必須・`acw`のみ・短期≦10分へ是正）
    - 【Step 2】クォータ/組織整合チェック未実装、`blobName` はサーバ返却値の強制使用へ
    - 【Step 2】クライアントは `BlockBlobClient.uploadData` + 進捗OK（期限切れ時の再発行導線追加）
- [!] ダウンロード/削除フロー（SAS/Functions・readのみ/冪等削除/監査）
  - コメント:
    - 【Step 2】ダウンロードSASAPI/削除APIが未実装、JWT検証・所有者/組織検証が必要
    - 【Step 2】ダウンロードSASは `read` のみ/短期（≦10分）。削除は必ず Functions 経由（delete SAS 不可）
    - 【Step 2】監査ログ（誰が何をDL/削除）/相関IDの記録が未整備
- [ ] Private Endpoint/Firewall 設定方針
  - コメント: 
    - PrivateEndpoint 未設定と思われる

## 3. バックエンド（Azure Functions / 非同期二段）
- [ ] セッションAPI: create/update/get/delete（HTTP Trigger）
  - コメント:
- [ ] 音声SAS発行: アップロード用一時SAS（権限・有効期限の最小化）
  - コメント:
- [ ] 生成処理エンドポイント: 受理(202)→ワーカー呼び出し
  - コメント:
- [ ] 文字起こしワーカー（Blob Trigger: Whisper呼び出し→保存→ステータス更新）
  - コメント:
- [ ] スケジュール処理（Timer Trigger: 月次リセット/期限切れクリーンアップ）
  - コメント:

## 4. AI連携（Azure OpenAI / Dify）
- [ ] Whisperによる多言語文字起こし（ja/en）
  - コメント:
- [ ] 箇条書き/議事録/タスク生成（Difyワークフロー or Functions実装）
  - コメント:
- [ ] 生成物の保存（出力コンテナ/メタデータ）
  - コメント:

## 5. リアルタイム更新
- [ ] 進捗通知: Polling もしくは SignalR/Web PubSub の導入
  - コメント:
- [ ] クライアント: セッション単位の進捗UI反映
  - コメント:

## 6. クォータ/利用制限（README_for_Yoshimoto 準拠）
- [ ] 残り時間（分）のアトミック減算（文字起こし完了時: 秒→分切上げ）
  - コメント:
- [ ] タスク生成回数のアトミック減算（生成完了時）
  - コメント:
- [ ] 月次リセット（Timer）/ UIの無効化連動
  - コメント:

## 7. フロントエンド/UI（要件定義書 8章）
- [ ] MediaUploader（形式判定/言語選択/進捗表示/大容量対応）
  - コメント:
- [ ] 話者認識・話者名編集（音声プレビュー含む）
  - コメント:
- [ ] 生成オプション（箇条書き/議事録/タスク）と結果表示
  - コメント:
- [ ] 一括ダウンロード（ZIP）/ 安全な削除
  - コメント:
- [ ] メンテナンスモード/バージョン表示・更新履歴
  - コメント:

## 8. セキュリティ/ネットワーク
- [ ] Key Vault による秘密情報管理（OpenAI/Dify/接続文字列）
  - コメント:
- [ ] Managed Identity / RBAC（Functions→Storage/Key Vault 等）
  - コメント:
- [ ] API保護（Access Token 必須・レート制限/APIM 任意）
  - コメント:
- [ ] 監査ログ（誰が何をDL/削除したか）
  - コメント:

## 9. 監視・ログ（App Insights/Log Analytics）
- [ ] リクエスト/依存関係トレース・相関ID設計
  - コメント:
- [ ] 障害/性能アラート（閾値定義）
  - コメント:

## 10. データ層/モデル
- [ ] 組織/ユーザー/ProcessingSession の永続化（Cosmos/SQL/その他）
  - コメント:
- [ ] クォータ更新の原子性/整合性（同時実行対策）
  - コメント:

---

### 備考（自由記入）
- 


