# 定期的なファイルクリーンアップ機能 実装方針案

## 1. 概要

本ドキュメントは、将来的な機能拡張として、S3バケットとDynamoDBテーブルに蓄積される古いセッションデータを定期的に削除するバッチ処理機能の実装方針を提案するものです。

## 2. 目的

-   **コスト最適化:** 不要になったS3オブジェクト（ユーザーがアップロードした入力ファイル、AIが生成した出力ファイル）を削除し、ストレージコストを削減する。
-   **データガバナンス:** 不要なユーザーデータを長期間保持しないというデータ管理ポリシーを徹底し、システムの健全性を維持する。
-   **パフォーマンス維持:** `ProcessingSession`テーブルから古いレコードを削除することで、テーブルサイズを適正に保ち、将来的なパフォーマンス問題を未然に防ぐ。

## 3. 推奨アーキテクチャ: EventBridge Scheduler + Lambda

最もモダンで堅牢な方法として、「Amazon EventBridge Scheduler」をトリガーとして、専用のクリーンアップ用Lambda関数を実行するアーキテクチャを提案します。

-   **Amazon EventBridge Scheduler:** 「毎日深夜3時に実行する」といったcron形式でスケジュールを定義し、ターゲットとしてLambda関数を指定します。
-   **cleanupExpiredSessions (新規Lambda):** スケジュールに従ってEventBridgeから呼び出されるバッチ処理用のLambda関数です。
-   **DynamoDB (`ProcessingSession` Table):** Lambda関数はこのテーブルを情報の起点（Source of Truth）として利用し、削除対象となるセッションを効率的に特定します。
-   **Amazon S3:** Lambda関数は、特定したセッションに関連する全てのファイル（入力ファイルと生成ファイル）をS3から削除します。

### このアーキテクチャの利点
-   **効率性:** S3バケットを直接スキャンするのではなく、DynamoDBを起点とすることで、削除対象を高速かつ安価に特定できます。
-   **信頼性:** EventBridge SchedulerがLambdaの呼び出しを保証するため、信頼性の高い実行が可能です。
-   **疎結合:** クリーンアップ処理がメインのアプリケーションフローから完全に分離されており、互いに影響を与えることなく個別に開発・メンテナンスができます。

## 4. Lambda関数の実装ステップ案

クリーンアップ用Lambda (`cleanupExpiredSessions`) の具体的な処理フローは以下の通りです。

1.  **削除基準の定義:**
    -   「最終更新日（`updatedAt`）から30日以上経過したセッション」のように、削除基準となる期間を定義します。
    -   この日数はLambdaの環境変数（例: `CLEANUP_THRESHOLD_DAYS=30`）で設定し、後から変更可能にします。

2.  **古いセッションの特定:**
    -   Lambda起動時に、現在時刻からしきい値となる日数（例: 30日前）を計算します。
    -   `ProcessingSession`テーブルに対し、`updatedAt`が計算したしきい値日時より古いレコードを問い合わせて、削除対象のセッションリストを取得します。

3.  **バッチ処理によるファイル削除:**
    -   取得したセッションリストをループ処理します。
    -   各セッションについて、削除対象となる全てのS3キーを特定します。
        -   **入力ファイル:** `private/{identityId}/{sessionId}/{fileName}`
        -   **生成ファイル:** `transcriptKey`, `bulletPointsKey`, `minutesKey`, `tasksKey`
    -   S3の`deleteObjects` API（複数オブジェクト一括削除）を利用して、特定したキーのファイルをまとめて削除します。

4.  **DynamoDBレコードの削除:**
    -   関連するS3ファイルの削除が完了した後、`ProcessingSession`テーブルから該当セッションのレコード自体を削除します。これにより、次回の実行で同じセッションが重複して処理されるのを防ぎます。

5.  **安全対策 (Dry Runモードの実装):**
    -   **【重要】** 誤操作によるデータ損失を防ぐため、安全装置として「Dry Runモード」を実装します。
    -   Lambdaの環境変数に `DRY_RUN=true` のようなフラグを設けます。
    -   `DRY_RUN`が`true`の場合、Lambdaは実際の削除処理（`s3:deleteObjects`やDynamoDBの`deleteItem`）を実行せず、代わりに「どのファイルとDBレコードを削除する予定だったか」という情報をCloudWatch Logsに詳細に出力します。
    -   これにより、本番環境で機能を有効化する前に、意図通りの動作をするかを安全に検証できます。

---
*このドキュメントは、将来的な機能実装のためのアイデアと方針をまとめたものです。* 