# Dify会話削除機能 実装前決定事項チェックリスト

## 1. 技術仕様・アーキテクチャ決定事項

### 1.1 Lambda関数仕様
- [x] **関数名**: `difyConversationCleaner` で確定
- [x] **ランタイム**: Node.js 18.x で確定
- [x] **メモリサイズ**: 128MB で確定
- [x] **タイムアウト**: 900秒（15分）で確定
- [x] **予約済み同時実行数**: 設定しない（デフォルト）
- [x] **デッドレターキュー**: 設定しない
- [x] **X-Ray トレーシング**: 無効

### 1.2 呼び出し方式
- [x] **呼び出しタイミング**: 各生成処理完了後にまとめて実行
- [x] **呼び出し方法**: Lambda Event（非同期）で確定
- [x] **リトライ制御**: Lambdaの標準リトライ（最大2回）で確定
- [x] **バッチ処理**: 複数conversation_idの一括削除を実装

### 1.3 依存関係
- [x] **PostgreSQLクライアント**: `pg` ライブラリで確定
- [x] **バージョン**: 最新安定版で確定
- [x] **接続プール**: 使用しない（単一接続/トランザクション）
- [x] **Lambda Layer**: 使用しない（関数内に`pg`を包含）

## 2. セキュリティ・権限設計決定事項

### 2.1 データベース認証
- [x] **DB認証方式**: SCRAM-SHA-256（ユーザー名・パスワード認証）
- [x] **Secrets Manager使用**: 必須（既存シークレットに追加 or 専用作成）
- [x] **認証情報ローテーション**: 手動管理（自動ローテーション無効）
- [x] **専用DBユーザー名**: 可能であれば `dify_cleaner`、困難なら既存admin使用

### 2.2 データベース権限
- [x] **最小権限の範囲**: SELECT + DELETE のみ（messagesテーブル限定）
- [x] **対象テーブル**: `messages`テーブルのみで確定
- [x] **WHERE句制限**: conversation_id による絞り込みのみで確定
- [x] **行レベルセキュリティ**: 実装しない（テーブルレベル権限で十分）

### 2.3 IAM権限
- [x] **VPC権限**: `AWSLambdaVPCAccessExecutionRole`（一部環境のみ、事前設定）
- [x] **Secrets Manager権限**: `secretsmanager:GetSecretValue` のみで確定
- [x] **CloudWatch Logs権限**: 標準の `AWSLambdaBasicExecutionRole` で確定
- [x] **Lambda Invoke権限**: generationWorkerに `lambda:InvokeFunction` 権限付与

## 3. インフラ・ネットワーク設計決定事項

### 3.1 VPC設定
VPC は一部の本番環境(prodtakewa)にのみ実装済み。それ以外では、
- [ ] **VPC**: DifyのPostgreSQLと同一VPCで確定か？
- [ ] **サブネット**: プライベートサブネット配置で確定か？
- [ ] **アベイラビリティゾーン**: 複数AZ配置するか？
- [ ] **ENI制限**: ENI作成上限に問題はないか？

### 3.2 セキュリティグループ
- [ ] **Lambda SG**: 新規作成 or 既存SG使用？
既存SG使用
- [ ] **DB SG**: 既存SG修正 or 新規ルール追加？
既存SG使用
- [ ] **アウトバウンドルール**: HTTPS (443) は必要か？（Secrets Manager接続）
不明
- [ ] **インバウンドルール**: Lambda SGには不要で確定か？
不明

### 3.3 DNS・名前解決
- [ ] **DB接続先**: IPアドレス or ホスト名？
不明
- [ ] **DNS解決**: VPC内DNSで解決可能か？
不明
- [ ] **プライベートDNSゾーン**: 必要か？
不明

## 4. データベース設計決定事項

dify セルフホスト版の仕様に準拠。以下、PostgreSQL最適設定を適用：

**推奨PostgreSQL設定**:
- `password_encryption = 'scram-sha-256'`, `scram_iterations = 4096` 以上
- `ssl = on`, `ssl_min_protocol_version = 'TLSv1.2'` 以上  
- `max_connections = 100` 程度（Dify + Lambda 全体見積もり）
- `statement_timeout = 5s`（削除処理タイムアウト防止）
- `idle_in_transaction_session_timeout = 30s`（不正トランザクション防止）

**pg_hba.conf設定例**:
```
# VPC CIDR のみ許可、SSL 必須、SCRAM-SHA-256 認証
hostssl  dify   dify_cleaner  10.0.0.0/16  scram-sha-256
```

### 4.1 Dify PostgreSQL調査必須項目
- [ ] **接続情報**: ホスト名、ポート、データベース名（要調査）
- [x] **SSL設定**: SSL必須（`ssl=on`, `ssl_min_protocol_version=TLSv1.2`）
- [ ] **接続プール設定**: max_connections の上限は？（要調査）
- [x] **タイムアウト設定**: `statement_timeout=5s`, `idle_in_transaction_session_timeout=30s`

### 4.2 テーブル構造確認
- [ ] **messagesテーブル**: 正確なスキーマ構造（要調査）
- [ ] **conversation_idカラム**: データ型（UUID? VARCHAR?）（要調査）
- [ ] **作成日時カラム**: `created_at`の正確なカラム名・型（要調査）
- [ ] **主キー**: `id`カラムのデータ型（要調査）
- [x] **インデックス**: `CREATE INDEX idx_messages_conversation_id ON messages (conversation_id);`

### 4.3 削除方式
- [x] **削除対象**: 最新メッセージのみ（`ORDER BY created_at DESC LIMIT 1`）
- [ ] **CASCADE削除**: 関連テーブルへの影響は？（要調査）
- [ ] **外部キー制約**: 削除時に制約エラーの可能性は？（要調査）
- [ ] **トリガー**: DELETE時に実行されるトリガーは？（要調査）

## 5. エラーハンドリング・運用設計決定事項

### 5.1 エラー分類
- [ ] **接続エラー**: リトライするか？（最大回数は？）
- [ ] **権限エラー**: 即座に失敗とするか？
- [ ] **データ不存在**: 正常終了とするか？
- [ ] **SQL構文エラー**: ログレベルは？（ERROR? WARN?）

### 5.2 ログ設計
- [ ] **ログレベル**: INFO, WARN, ERROR の基準
- [ ] **ログ形式**: JSON構造化ログで統一するか？
- [ ] **機密情報**: conversation_id はマスキングするか？
- [ ] **ログ保持期間**: CloudWatch Logsの保持期間設定

### 5.3 監視・アラート
- [ ] **成功率監視**: 閾値は？（95%? 99%?）
- [ ] **実行時間監視**: アラート閾値は？（10秒? 30秒?）
- [ ] **エラー率監視**: 連続失敗回数の閾値は？
- [ ] **通知先**: SNS、Slack、メール？

## 6. パフォーマンス・スケーラビリティ決定事項

### 6.1 同時実行制御
- [ ] **最大同時実行数**: 何件まで同時実行を許可するか？
- [ ] **スロットリング**: DLQへの送信 or エラー返却？
- [ ] **接続プール**: PostgreSQL側の max_connections との調整

### 6.2 実行時間最適化
- [ ] **接続キープアライブ**: 使用するか？
- [ ] **クエリ最適化**: EXPLAINでの実行計画確認済みか？
- [ ] **インデックス追加**: 必要な場合の対応方針

## 7. テスト設計決定事項

### 7.1 単体テスト
- [ ] **テスト環境**: 専用PostgreSQLインスタンス構築するか？
- [ ] **テストデータ**: どのようなconversation_idでテストするか？
- [ ] **モック使用**: PostgreSQL接続をモック化するか？

### 7.2 統合テスト
- [ ] **E2Eテスト**: generationWorker → cleaner の完全なフロー
- [ ] **障害テスト**: PostgreSQL停止時の動作確認
- [ ] **負荷テスト**: 同時実行時の動作確認

### 7.3 セキュリティテスト
- [ ] **権限テスト**: 不正なDBユーザーでの接続試行
- [ ] **SQLインジェクション**: パラメータ化クエリの確認
- [ ] **接続情報漏洩**: ログからの機密情報漏洩確認

## 8. デプロイ・リリース戦略決定事項

### 8.1 段階的デプロイ
- [ ] **環境順序**: dev → staging → prod で確定か？
- [ ] **カナリアデプロイ**: 実装するか？
- [ ] **ロールバック計画**: 問題発生時の切り戻し手順

### 8.2 フィーチャーフラグ
- [ ] **環境変数制御**: `DIFY_DELETE_CONVERSATIONS` で十分か？
- [ ] **段階的有効化**: 一部ユーザーのみ先行有効化するか？
- [ ] **無効化手順**: 緊急時の即座無効化方法

### 8.3 影響範囲
- [ ] **既存機能**: 生成処理への影響がないことの確認方法
- [ ] **パフォーマンス**: 生成処理時間への影響測定方法
- [ ] **ユーザー通知**: 機能追加の事前・事後通知は必要か？

## 9. コスト・運用決定事項

### 9.1 コスト見積もり
- [ ] **Lambda実行コスト**: 月間実行回数の見積もり
- [ ] **VPC ENIコスト**: ENI作成・維持コスト
- [ ] **CloudWatch Logsコスト**: ログ保存容量の見積もり
- [ ] **Secrets Managerコスト**: 認証情報保存コスト

### 9.2 運用・保守
- [ ] **定期メンテナンス**: PostgreSQLクライアント更新頻度
- [ ] **障害対応**: 24時間対応が必要か？
- [ ] **バックアップ**: 削除ログのバックアップは必要か？

## 10. Dify環境調査必須確認事項

### 10.1 現在のDify構成
- [ ] **Difyバージョン**: 使用中のDifyバージョン確認
- [ ] **PostgreSQLバージョン**: 使用中のPostgreSQLバージョン
- [ ] **Docker構成**: Docker Compose設定の確認
- [ ] **ネットワーク構成**: Difyの実際のネットワーク設定

### 10.2 データベース接続確認
- [ ] **接続テスト**: 手動でのPostgreSQL接続確認
- [ ] **現在の接続数**: `SELECT * FROM pg_stat_activity;` で確認
- [ ] **認証方式**: `pg_hba.conf` の設定確認
- [ ] **SSL設定**: `postgresql.conf` のSSL設定確認

### 10.3 権限・セキュリティ確認
- [ ] **既存ユーザー**: 現在のDBユーザー一覧
- [ ] **権限設定**: 各ユーザーの権限確認
- [ ] **セキュリティグループ**: 現在のSG設定
- [ ] **アクセスログ**: PostgreSQLのアクセスログ設定

## 11. 実装優先度・Phase分け

### 11.1 Phase 1 (必須)
- [ ] **基本的な削除機能**: 単一conversation_idの削除
- [ ] **エラーハンドリング**: 基本的な例外処理
- [ ] **ログ出力**: 成功・失敗ログ

### 11.2 Phase 2 (推奨)
- [ ] **監視・アラート**: CloudWatch メトリクス
- [ ] **接続プール**: 性能最適化
- [ ] **リトライ機能**: 一時的エラーへの対応

### 11.3 Phase 3 (将来)
- [ ] **バッチ削除**: 複数conversation_idの一括処理
- [ ] **削除ログ保存**: 監査ログの永続化
- [ ] **自動復旧**: 失敗時の自動リトライ

---

## 決定事項記録テンプレート

各項目について以下の形式で決定事項を記録：

```
項目: [項目名]
決定内容: [具体的な決定内容]
理由: [決定理由]
代替案: [検討した他の選択肢]
リスク: [想定されるリスク]
確認日: [YYYY-MM-DD]
確認者: [確認者名]
```

## 実装開始判定基準

- [ ] **必須項目**: セクション1-5の全項目が決定済み
- [ ] **調査完了**: セクション10の全項目が確認済み  
- [ ] **環境準備**: テスト環境の構築完了
- [ ] **承認取得**: セキュリティ・運用面での承認取得

**実装開始可能**: 上記4項目がすべて✅になった時点 