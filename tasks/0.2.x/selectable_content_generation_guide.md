# 選択式コンテンツ生成機能 実装方針書

## 1. 概要

本ドキュメントは、既存の「transcript-minute」アプリケーションにおいて、ユーザーが生成したいコンテンツ（箇条書き、議事録、タスク一覧）を任意に選択できる機能を追加するための実装方針を定義する。

これにより、ユーザーの利便性向上と、不要なコンテンツ生成に伴うAPIコストの削減を実現する。

## 2. 方針サマリー

| 項目 | 方針 | 詳細 |
| :--- | :--- | :--- |
| **UI** | **チェックボックス** | 「箇条書き」「議事録」「タスク一覧」の3つのチェックボックスを配置する。 |
| **デフォルト状態** | 初回は一部ON | 初回利用時は「箇条書き」「議事録」をON、「タスク一覧」をOFFとする。 |
| **状態の永続化** | **`localStorage`** | ユーザーの選択状態をブラウザの`localStorage`に保存し、次回以降のデフォルト値として利用する。 |
| **タスク一覧UI** | **条件付き表示** | 「タスク一覧」チェックボックスがONの場合にのみ、関連ファイルのアップロードUIを表示する。 |
| **API連携** | **既存の配列を流用** | 選択された項目を`processingTypes`配列に含めてAPIに渡す。バックエンドの大きな変更は不要。 |
| **結果表示** | **条件付き表示** | 生成されなかったコンテンツのセクションは、結果画面に表示しない。 |
| **ダウンロード** | **動的に対象を指定** | 生成されたコンテンツのみを一括ダウンロードのzipファイルに含める。 |
| **エラーハンドリング** | **個別表示** | 特定のコンテンツ生成が失敗した場合、成功分は表示し、失敗分にはエラーメッセージを表示する。 |

## 3. アーキテクチャとファイル構成

本機能は、UIコンポーネントとそのロジックをカスタムフックに分離する、既存の優れた設計思想を踏襲する。

- **`hooks/useGenerationOptions.ts` (新規作成)**:
  -   コンテンツ選択の状態（チェックボックスのON/OFF）を管理する。
  -   `localStorage`との同期処理（状態の保存と復元）を担う。
  -   UIコンポーネントや他のコンポーネントで利用するための状態と更新関数を提供する。

- **`components/GenerationOptions.tsx` (新規作成)**:
  -   `useGenerationOptions`フックを利用して、UI（チェックボックス等）の描画に専念する。Props経由でのデータ受け渡しは行わない。

- **`components/TranscriptionResult.tsx` (既存コンポーネント)**:
  -   `useGenerationOptions`フックを利用して、ユーザーの選択状態を取得し、APIリクエストの構築などに利用する。

## 4. 実装ステップ

### ステップ1: 状態管理ロジックの実装 (`useGenerationOptions.ts`)

1.  **カスタムフックの作成**:
    -   `src/hooks/useGenerationOptions.ts` ファイルを新規作成する。
2.  **状態管理**:
    -   `useState`フックを用いて、選択オプションの状態（例: `{ bullets: true, minutes: true, tasks: false }`）を管理する。
3.  **状態の永続化**:
    -   `useEffect`フックを2つ実装する。
        -   1つ目は、コンポーネントのマウント時に`localStorage`から保存された設定を読み込み、stateを初期化するため。
        -   2つ目は、状態が変更されるたびに`localStorage`へ最新の状態を保存するため。
4.  **返り値**:
    -   フックは、現在の状態オブジェクトと、それを更新するための関数を返す。

### ステップ2: UIコンポーネントの実装 (`GenerationOptions.tsx`)

1.  **コンポーネントの作成**:
    -   `src/components/GenerationOptions.tsx` ファイルを新規作成する。
2.  **フックの利用**:
    -   コンポーネント内で`useGenerationOptions`フックを呼び出し、状態と更新関数を取得する。
3.  **UIの描画**:
    -   取得した状態を基に、3つのチェックボックスを描画する。`onChange`イベントで更新関数を呼び出す。
    -   「タスク一覧」がONの場合にのみ、ファイルアップロードUIを描画する条件分岐を追加する。
4.  **`TranscriptionResult.tsx`への統合**:
    -   `TranscriptionResult.tsx`内の適切な場所（「文字起こし結果」と「生成」ボタンの間）に、`<GenerationOptions />`コンポーネントを配置する。

### ステップ3: フロントエンドのロジック連携 (`TranscriptionResult.tsx`)

1.  **フックの利用**:
    -   `TranscriptionResult.tsx`内でも`useGenerationOptions`フックを呼び出し、選択状態を取得する。
2.  **API呼び出し処理の修正 (`handleGenerateClick`)**:
    -   「生成」ボタンクリック時のハンドラで、フックから取得した状態を基に`processingTypes`配列を動的に構築する。
    -   `processingTypes`が空の場合は、「生成」ボタンを非活性化する。
3.  **結果表示エリアの修正**:
    -   `session`オブジェクトの`bulletPointsKey`, `minutesKey`, `tasksKey`の存在有無に基づき、各結果表示セクションの表示を制御する。
4.  **ダウンロード機能の修正**:
    -   一括ダウンロード機能で、`session`にキーが存在する成果物のみをzipに含めるように修正する。

### ステップ4: エラーハンドリングと最終調整

-   `ProcessingSession`モデルの`status`フィールドを監視し、失敗したコンテンツのエリアにエラーメッセージを表示する。
-   成功した項目は通常通り表示・ダウンロードできるようにする。

### ステップ5: バックエンド

-   フロントエンドから渡される`processingTypes`配列の内容に応じて処理を分岐するロジックは、`generationWorker`に既に実装されているため、バックエンド側での大きな変更は不要。
-   `processingTypes`が空の配列で渡された場合の動作については、フロントエンド側で制御するため、バックエンド側での特別な考慮は不要とする。 