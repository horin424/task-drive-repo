# 話者編集機能 改善 実施チェックリスト

このドキュメントは `speaker_editing_improvement_plan.md` に基づき、実際に行う作業をタスク単位でリスト化したものです。

### フェーズ1: バックエンドとGraphQLスキーマの変更

- [x] **1. GraphQL スキーマの更新 (`schema.graphql`)**
    - [x] `Query` 型に `getAudioPresignedUrl(sessionId: ID!): String` を追加する。
    - [x] `enum TranscriptFormat { JSON TEXT }` を新規追加する。
    - [x] `ProcessingSession` 型に `transcriptFormat: TranscriptFormat` フィールドを追加する。

- [x] **2. バックエンドのデプロイと型生成**
    - [x] `amplify push` を実行して、バックエンドの変更をクラウドにデプロイする。
    - [x] `amplify codegen` を実行して、フロントエンドで利用するGraphQLの型定義を更新する。

- [x] **3. `getAudioPresignedUrl` リゾルバーの実装**
    - [x] `amplify add function` コマンドで専用のLambda関数を作成する。
    - [x] Lambda関数に、`ProcessingSession`のIDから音声ファイルの署名付きURLを生成するロジックを実装する。
    - [x] リゾルバーに、リクエスト元のユーザーがセッションの所有者か検証するロジックを実装する。
    - [x] GraphQLスキーマの`getAudioPresignedUrl`クエリとLambda関数を接続する。

- [x] **4. `transcriptionProcessor` Lambda の修正**
    - [x] 出力形式を、設計書で定義されたカスタムJSON形式に変更する。(`words` 配列を含む)
    - [x] `ProcessingSession` を更新する際、`transcriptFormat` フィールドを `JSON` に設定する処理を追加する。

### フェーズ2: フロントエンドのデータ層リファクタリング

- [x] **1. 音声URL取得処理の実装**
    - [x] `src/lib/api.ts` (または対応するファイル) に、`getAudioPresignedUrl` クエリを呼び出す関数を実装する。

- [x] **2. データ取得ロジックの改修**
    - [x] 文字起こし結果を表示するコンポーネント (`TranscriptionResult.tsx` など) で、セッションの `transcriptFormat` を確認する処理を追加する。
    - [x] `transcriptFormat` が `JSON` の場合、S3から中間JSONファイルをダウンロードしてパースする。
    - [x] `transcriptFormat` が `TEXT` の場合、従来通りテキストファイルをダウンロードして表示する。

- [x] **2-1. TEXT形式処理の削除（追加タスク）**
    - [x] 実装の簡潔性と可読性を重視し、JSON形式のみをサポートするようにコードを修正する。
    - [x] `useTranscriptionResult.ts`からTEXT形式の処理を削除する。
    - [x] `TranscriptionResult.tsx`からTEXT形式の処理を削除する。

- [x] **3. `useSpeakerEditing` フックの改修**
    - [x] フックが、文字列の代わりに `words` 配列を初期データとして受け取るように修正する。
    - [x] `words` 配列を、UI表示用の `SpeechSegment[]` 配列に変換（グルーピング）するロジックを実装する。
    - [x] 状態管理の中心を、この `SpeechSegment[]` 配列で行うように変更する。

### フェーズ3: UIコンポーネントの実装

- [x] **1. `SpeakerNameEditor.tsx` の改修**
    - [x] `SpeechSegment[]` 配列を元に、発言ブロックのリストを描画するように変更する。
    - [x] `getAudioPresignedUrl` で取得したURLを非表示の `<audio>` 要素に設定する。
    - [x] 再編集が不可である旨の注意書きテキストをコンポーネント内の分かりやすい位置に追加する。

- [x] **2. 話者の個別編集UIの実装**
    - [x] 各発言ブロックに、話者を選択・変更するためのドロップダウンメニューを実装する。
    - [x] ドロップダウンでの選択に応じて、`SpeechSegment` の `speakerId` を更新する状態管理ロジックを実装する。
    
    **完了**: 個別セグメントの話者変更機能の完全実装
    - [x] `useSpeakerEditing`フックに`updateSegmentSpeaker`関数を追加
    - [x] セグメントレベルでの話者変更機能を実装
    - [x] 新しい話者IDが追加された場合の`speakerMap`自動更新機能を実装
    - [x] リアルタイムでの表示更新機能を実装

- [x] **3. 音声プレビュー機能の実装**
    - [x] 発言ブロックがクリックされた際に、`<audio>` 要素の再生時間を `startTime` に設定し、再生を開始するロジックを実装する。
    - [x] 音声が `endTime` に達したら再生を停止するロジックを実装する (`timeupdate` イベントを利用)。
    - [x] 再生中のブロックを視覚的にハイライトするCSSとロジックを実装する。

### フェーズ4: 保存処理と最終化

- [x] **1. 保存ロジックの実装 (`useSpeakerEditing`)**
    - [x] 編集済みの `SpeechSegment[]` 配列を、最終成果物であるプレーンテキスト形式 (`[話者名]:\n発言内容...`) に変換する関数を実装する。
    - [x] 「編集を完了」ボタンが押された際に、生成したテキストでS3上の中間JSONファイルを上書きする処理を実装する。

- [x] **2. セッション状態の更新処理**
    - [x] テキストファイルの上書き保存が成功した後、`updateSession` ミューテーションを呼び出し、`transcriptFormat` を `TEXT` に更新する。

- [x] **3. UIの動的制御**
    - [x] 親コンポーネント (`TranscriptionResult.tsx` など) が `transcriptFormat` の値に応じて、「話者を編集」ボタンの表示/非表示を切り替えるロジックを実装する。

### フェーズ5: テスト項目

- [ ] **1. 基本的な話者編集機能のテスト**
    - [ ] 新しい文字起こしセッションで話者編集画面が正常に表示される
    - [ ] 左パネルの話者名入力フィールドが正しく動作する
    - [ ] 話者名の変更がプレビューにリアルタイムで反映される
    - [ ] 複数の話者名を変更できる
    - [ ] 話者名が空の場合は元のspeaker_idが表示される

- [ ] **2. 個別セグメント話者変更機能のテスト**
    - [ ] 各発言ブロックにドロップダウンメニューが表示される
    - [ ] ドロップダウンで話者を変更すると表示が即座に更新される
    - [ ] 異なる話者に変更した場合、話者色が正しく変更される
    - [ ] 新しい話者IDが動的に話者リストに追加される
    - [ ] 個別変更と全体名前変更が正しく連動する

- [ ] **3. 音声プレビュー機能のテスト**
    - [ ] 音声ファイルの署名付きURLが正常に取得される
    - [ ] 各発言ブロックの再生ボタンが表示される
    - [ ] 再生ボタンクリックで該当箇所の音声が再生される
    - [ ] 音声が指定されたendTimeで自動停止する
    - [ ] 再生中のブロックが視覚的にハイライトされる
    - [ ] 音声読み込み中は適切なローディング状態が表示される

- [ ] **4. 保存処理のテスト**
    - [ ] 「編集を完了」ボタンが正常に動作する
    - [ ] 編集内容がプレーンテキスト形式で保存される
    - [ ] 保存後にtranscriptFormatがTEXTに変更される
    - [ ] 保存後にセッションステータスがSPEAKER_EDIT_COMPLETEDに変更される
    - [ ] 保存中は適切なローディング状態が表示される

- [ ] **5. 編集状態管理のテスト**
    - [ ] transcriptFormat=JSONの場合のみ話者編集が可能
    - [ ] transcriptFormat=TEXTの場合は編集不可メッセージが表示される
    - [ ] 編集完了後は再編集ができない状態になる
    - [ ] 注意書きが適切な位置に表示される

- [ ] **6. エラーハンドリングのテスト**
    - [ ] 音声URL取得に失敗した場合の適切なエラーハンドリング
    - [ ] 音声再生に失敗した場合の適切なエラーハンドリング
    - [ ] 保存処理に失敗した場合の適切なエラーハンドリング
    - [ ] ネットワークエラー時の適切なエラーメッセージ表示
    - [ ] 無効なセッションIDでのアクセス時のエラーハンドリング

- [ ] **7. UI/UXのテスト**
    - [ ] 話者色が一貫して表示される
    - [ ] レスポンシブデザインが正常に動作する
    - [ ] 長い発言内容が適切に表示される
    - [ ] 多数の発言ブロックがある場合のスクロール動作
    - [ ] ドロップダウンメニューの選択肢が適切に表示される

- [ ] **8. データ整合性のテスト**
    - [ ] SpeechSegment配列が正しく生成される
    - [ ] words配列からの変換が正確に行われる
    - [ ] 話者変更後もタイムスタンプ情報が保持される
    - [ ] 最終テキスト形式が仕様通りの形式で出力される
    - [ ] 話者交代時の空行が正しく挿入される

- [ ] **9. パフォーマンステスト**
    - [ ] 大量の発言ブロックがある場合の表示パフォーマンス
    - [ ] 話者変更時のレスポンス時間が適切
    - [ ] 音声ファイルの読み込み時間が適切
    - [ ] メモリ使用量が適切な範囲内

- [ ] **10. 統合テスト**
    - [ ] 文字起こし処理から話者編集まで一連の流れが正常
    - [ ] 話者編集完了後のコンテンツ生成が正常に動作
    - [ ] ダウンロード機能が編集後のテキストを正しく取得
    - [ ] 既存の機能が破綻していない
    - [ ] 複数ユーザーでの同時利用が正常に動作