
# フロントエンド リファクタリング計画書

## 背景
現状のフロントエンド実装は、一部のコンポーネントが肥大化し、状態管理ロジックとUIレンダリングが密結合している。これにより、コードの見通しが悪化し、機能追加や改修が困難になりつつある。本計画では、保守性と拡張性を向上させることを目的としたリファクタリングを実施する。

## 全体方針
- **責務の分離**: コンポーネントからビジネスロジックと状態管理を分離する。
- **コンポーネントの粒度最適化**: 巨大なコンポーネントを再利用可能な小さなコンポーネントに分割する。
- **状態管理の集約**: 複雑な状態遷移を予測可能にするため、クライアント状態とサーバー状態を分離し、それぞれに適した状態管理手法を導入する。
- **コードの一貫性担保**: 型定義やAPIクライアント、共通ユーティリティを整備し、コードベース全体の一貫性を高める。

## 個別リファクタリング項目

### 1. `TranscriptionResult.tsx` (最優先)
- **課題**: 1200行超。データ取得、状態管理、UIレンダリング、API連携の責務が集中。
- **方針**:
    - **ロジックのカスタムフック化**:
        - `useTranscriptionResult.ts`: データ取得、コンテンツ生成、ダウンロード処理などの主要ロジックを集約。**TanStack Query の `useQuery` / `useMutation` を活用**し、キャッシュ管理や非同期処理の責務をフック内にカプセル化する。
        - `useSpeakerEditing.ts`: 話者編集機能に関する状態とロジックを分離。
    - **コンポーネント分割**:
        - `ResultDisplay.tsx`: 各結果セクション（文字起こし、箇条書き等）の表示。
        - `ActionButtons.tsx`: ユーザーアクションボタン群。
        - `GenerationForm.tsx`: ファイルアップロードフォーム。
    - **状態管理改善**:
        - `useReducer` を導入し、コンテンツ生成プロセスの複雑な状態遷移を管理する。

### 2. `MediaUploader.tsx`
- **課題**: 700行超。ファイル選択UI、ドラッグ＆ドロップ、プログレス表示、API連携、サブスクリプション管理など多くの責務が混在。
- **方針**:
    - **ロジックのカスタムフック化**:
        - `useMediaUpload.ts`: ファイルバリデーション、S3アップロード、`ProcessingSession` の作成、WebSocketサブスクリプション管理などのバックエンド連携ロジックをすべて分離・集約する。ここでも **TanStack Query を活用**してAPI呼び出しを管理する。
    - **コンポーネント分割**:
        - `FileDropzone.tsx`: ドラッグ＆ドロップエリアのUIとイベントハンドリングに特化。
        - `FileInfoDisplay.tsx`: 選択されたファイル情報（名前、サイズ、再生時間）や残り時間超過警告の表示。
        - `LanguageSelector.tsx`: 言語選択プルダウンのUIと状態管理。
        - `UploadProgress.tsx`: アップロード進行状況の表示。

### 3. `SpeakerNameEditor.tsx`
- **課題**: 14KB超。話者名の抽出、編集UI、更新処理が一体化。
- **方針**:
    - `useSpeakerNames.ts` フックを作成し、話者リストの抽出と管理ロジックを分離する。
    - 編集可能な話者名リスト `EditableSpeakerList.tsx` をコンポーネントとして切り出す。

### 4. `page.tsx` (メインページ)
- **課題**: アプリケーションのメインコンポーネントとして認証、ユーザー情報取得、主要コンポーネントの表示切り替えなど責務が集中。Propsによる状態のバケツリレーが多発。
- **方針**:
    - **状態管理の集約 (グローバル化)**:
        - `organization` や `remainingMinutes` などのサーバーから取得する状態は **TanStack Query** で管理し、キャッシュを有効活用する。
        - `currentStep` などのUIに閉じたグローバルな状態は **Zustand** を用いて管理し、Propsのバケツリレーを解消する。
    - **認証・初期化ロジックの分離**:
        - `useAuthInit.ts` カスタムフックを作成し、認証確認、ユーザー・組織情報の取得・作成といった初期化処理をUIから分離する。
    - **レイアウトコンポーネントの導入**:
        - プロセスの各段階（アップロード、処理中、結果表示）に対応するコンポーネント (`UploadStep.tsx` 等)を導入し、`page.tsx` は現在のステップに応じて適切なコンポーネントを表示する責務に限定する。
    - **コンポーネント分割**:
        - ヘッダー部分を `AppHeader.tsx` として切り出す。

## 横断的なリファクタリング項目

### 1. 状態管理ライブラリの導入
- **課題**: `useState` と Props のバケツリレーによる状態管理の複雑化。サーバーの状態とクライアントの状態が区別されていない。
- **提案**: **Zustand** と **TanStack Query (React Query)** を役割を明確にして併用する。
    - **TanStack Query**: サーバー状態管理を担当。
        - GraphQL/REST APIのデータ取得、キャッシュ、同期、リトライ。
        - `useQuery` でデータ取得、`useMutation` でデータ更新を行う。
    - **Zustand**: クライアント状態管理を担当。
        - モーダルの開閉、プロセスステップ (`currentStep`)、フォーム入力内容など、UIに紐づくグローバルな状態。
- **効果**: それぞれのライブラリの得意分野を活かし、責務が明確でパフォーマンスの良い状態管理を実現する。

### 2. APIクライアントと型定義の集約
- **課題**: API呼び出しロジックが各コンポーネントに散在。Amplify生成の型とカスタムの型が混在。
- **方針**:
    - `src/lib` や `src/services` ディレクトリを作成。
    - `api.ts`: `generateClient()` で生成したクライアントをラップし、GraphQLクエリ/ミューテーションを呼び出す関数をここに集約する。TanStack Queryの `queryFn` から呼び出されることを想定する。
    - `storage.ts`: `getUrl`, `uploadData` などのS3関連処理をまとめる。
    - `difyApi.ts`: Dify API関連の処理をまとめる。
    - `src/types/index.ts`: プロジェクト固有の型定義を集約し、Amplify Codegenで生成される型は `src/API.ts` からbarrel exportして再利用する。

### 3. エラーハンドリングとロギングの統合
- **課題**: GraphQL, REST, S3など、エラー発生源が多岐にわたり、ユーザーへのフィードバックが統一されていない。
- **方針**:
    - `utils/errorHandler.ts`: エラーオブジェクトを引数に取り、整形されたユーザー向けメッセージと開発者向けログを返す共通ハンドラを定義する。
    - TanStack Queryの `onError` や `try-catch` 文でこの共通ハンドラを呼び出す。
    - Zustandストアにグローバルなエラー状態を持たせ、共通のエラー表示コンポーネントやトーストでユーザーに通知する。

### 4. スタイリングとUIコンポーネント
- **課題**: インラインスタイルやCSS Modulesが混在。基本的なUI部品が標準化されていない。
- **方針**:
    - スタイリングは **CSS Modules** に統一する。Tailwind CSSの導入は今回見送る。
    - `page.tsx` のグローバルスタイルを `globals.css` に移管し、ダークモード対応を一元化する。
    - `next/dynamic` や `React.lazy` を活用し、`MediaUploader` のような巨大なコンポーネントを遅延読み込みして初期バンドルサイズを削減する。
    - `src/components/ui` に、`Button.tsx`, `Modal.tsx` などの汎用コンポーネントを作成する（Storybookは導入しない）。

### 5. ユーティリティ関数の抽出
- **課題**: 汎用的に使えるはずのヘルパー関数がコンポーネント内に定義されている。
- **方針**:
    - `src/utils` ディレクトリ内に、責務に応じたファイルを作成し、関数を移管する。
        - `formatters.ts`: `formatDuration` のような表示フォーマット用関数。
        - `transcriptParser.ts`: `TranscriptionResult.tsx` 内の話者タグを解釈して表示用データに変換するロジック。
        - `errorUtils.ts` は `errorHandler.ts` に統合する。

## 将来的な改善項目（今回のリファクタリング範囲外）

本リファクタリング完了後、さらなる品質と保守性向上のため、以下の項目を検討することを推奨します。

- **パフォーマンス最適化**:
  - `React.memo`, `useMemo`, `useCallback` を活用し、不要な再レンダリングを抑制する。
  - 特にロジック分離後のコンポーネントに対して、React Developer Toolsのプロファイラを用いてボトルネックを特定し、効果的な箇所に適用する。

- **テストコードの導入**:
  - `Jest` と `React Testing Library` を用いたテストを導入する。
  - まずは `utils` や `lib` 内のビジネスロジックに対するユニットテストから開始し、徐々にコンポーネントの結合テストやスナップショットテストに範囲を広げる。
  - リファクタリングによるデグレードを防止し、将来の機能追加を安全に行うための基盤となる。

- **StorybookによるUIコンポーネントカタログ**:
  - 共通UIコンポーネント (`src/components/ui`) をStorybookで管理する。
  - コンポーネントの再利用性を高め、UIの一貫性を視覚的に確認しながら開発を進めることができる。

## 実施計画 (改訂版)
1. **フェーズ1: 横断的基盤の整備 (APIクライアント / utils / 型集約)**
   - `Zustand`, `@tanstack/react-query` をインストール。
   - `src/lib` (or `services`) に `api.ts`, `storage.ts` を作成し、API呼び出しロジックを集約する。
   - `src/utils` にヘルパー関数を移管する。
   - `src/stores` に `sessionStore`, `uiStore` の雛形を作成する。
   - TanStack Query の `QueryClientProvider` をアプリケーションのルートに設定する。
2. **フェーズ2: ロジックの分離 (Hooks)**
   - `useTranscriptionResult`, `useMediaUpload` 等のカスタムフックを作成する。API通信は、フェーズ1で作成したAPIクライアントと `useQuery`/`useMutation` を利用して実装する。
3. **フェーズ3: コンポーネントの分割**
   - フェーズ2でフックを適用したコンポーネントを、計画に基づき小さなコンポーネントに分割する。
4. **フェーズ4: グローバル状態の再編とUIリファクタリング**
   - `page.tsx` をリファクタリングし、Propsのバケツリレーを解消。状態の参照を各コンポーネントがストアから直接行うように変更する。
   - スタイリングの整理や共通UIコンポーネントの適用を進める。

## 今回のスコープに含めない項目 (参照)
以下の項目は、アプリケーションの品質と開発体験を向上させる上で非常に重要ですが、今回のリファクタリングのスコープ外とします。将来的な改善タスクとして検討することを推奨します。

- **CI/CDと静的解析の導入**:
    - **内容**: GitHub Actions等でESLint, Prettier, 型チェックを自動実行する仕組み。
    - **見送り理由**: まずは主要なロジックのリファクタリングに集中するため。

- **テスト戦略**:
    - **内容**: Jest, React Testing Libraryを用いたユニットテストや結合テストの導入。
    - **見送り理由**: テストがない状態からの導入は工数が大きく、リファクタリングと並行すると複雑性が増すため。リファクタリング後の品質担保フェーズで導入を検討。

- **StorybookによるUIコンポーネントカタログ**:
    - **内容**: UIコンポーネントを一覧化し、独立した環境で開発・確認するツール。
    - **見送り理由**: 共通UIコンポーネントの整備は行うが、カタログ化までは今回のスコープに含めない。

- **アクセシビリティ (a11y) の強化**:
    - **内容**: WAI-ARIAに基づいた適切な属性の付与や、キーボード操作の担保。
    - **見送り理由**: 機能的なリファクタリングを優先するため。ただし、`Button`等のUIコンポーネント作成時に基本的な配慮は行う。

- **国際化 (i18n) 対応**:
    - **内容**: テキストをロケールファイルに分離し、多言語対応の基盤を整える。
    - **見送り理由**: 現状の要求仕様に多言語対応が含まれていないため。 